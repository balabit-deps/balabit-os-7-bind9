From 02e8b3f8dcfdb9877cb053af7ca34809e8543420 Mon Sep 17 00:00:00 2001
From: Evan Hunt <each@isc.org>
Date: Thu, 5 Jul 2018 18:57:48 -0700
Subject: [PATCH 2/2] test case

(cherry picked from commit 73486c13f743407a50d5bbadde90c949a696506f)
(cherry picked from commit 584a1cff8b8c00310cee6b1735cb39664bf6899d)

[Ubuntu note: changed named.conf.in to named.conf, as the conversion to
 the former had not happened yet. Also convert echo_i() test invocations
 into echo "I:" --sbeattie]
---
 bin/tests/system/chain/ns7/named.conf |    6 ++++++
 bin/tests/system/chain/tests.sh       |   17 +++++++++++++++++
 2 files changed, 23 insertions(+)

Index: b/bin/tests/system/chain/ns7/named.conf
===================================================================
--- a/bin/tests/system/chain/ns7/named.conf
+++ b/bin/tests/system/chain/ns7/named.conf
@@ -19,6 +19,12 @@ options {
 	listen-on-v6 { fd92:7065:b8e:ffff::7; };
 	recursion yes;
 	allow-recursion { any; };
+	dnssec-validation yes;
+	deny-answer-aliases {
+		"example";
+	} except-from {
+		"example";
+	};
 };
 
 key rndc_key {
Index: b/bin/tests/system/chain/tests.sh
===================================================================
--- a/bin/tests/system/chain/tests.sh
+++ b/bin/tests/system/chain/tests.sh
@@ -244,5 +244,22 @@ $RNDC -c ../common/rndc.conf -s 10.53.0.
 if [ $ret != 0 ]; then echo "I:failed"; fi
 status=`expr $status + $ret`
 
+n=`expr $n + 1`
+echo "I:checking explicit DNAME query ($n)"
+ret=0
+$DIG $DIGOPTS @10.53.0.7 dname short-dname.example > dig.out.7.$n 2>&1
+grep 'status: NOERROR' dig.out.7.$n > /dev/null 2>&1 || ret=1
+if [ $ret != 0 ]; then echo "I:failed"; fi
+status=`expr $status + $ret`
+
+n=`expr $n + 1`
+echo "I:checking DNAME via ANY query ($n)"
+ret=0
+$RNDCCMD 10.53.0.7 flush 2>&1 | sed 's/^/ns7 /' | cat_i
+$DIG $DIGOPTS @10.53.0.7 any short-dname.example > dig.out.7.$n 2>&1
+grep 'status: NOERROR' dig.out.7.$n > /dev/null 2>&1 || ret=1
+if [ $ret != 0 ]; then echo "I:failed"; fi
+status=`expr $status + $ret`
+
 echo "I:exit status: $status"
 [ $status -eq 0 ] || exit 1
