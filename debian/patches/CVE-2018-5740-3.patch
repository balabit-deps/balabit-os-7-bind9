From ba162bd0d49dfb699162712b1c22783bc88b1632 Mon Sep 17 00:00:00 2001
From: Evan Hunt <each@isc.org>
Date: Tue, 24 Jul 2018 10:21:52 -0700
Subject: [PATCH] caclulate nlabels and set *chainingp correctly

(cherry picked from commit e78e55f435e2ee901e609750595f94225cb3e369)
---
 bin/tests/system/resolver/tests.sh |    1 +
 lib/dns/resolver.c                 |    7 ++++---
 2 files changed, 5 insertions(+), 3 deletions(-)

Index: b/bin/tests/system/resolver/tests.sh
===================================================================
--- a/bin/tests/system/resolver/tests.sh
+++ b/bin/tests/system/resolver/tests.sh
@@ -196,6 +196,7 @@ n=`expr $n + 1`
 echo "I:checking DNAME target filtering (deny) ($n)"
 ret=0
 $DIG +tcp foo.baddname.example.net @10.53.0.1 a -p 5300 > dig.out.ns1.test${n} || ret=1
+grep "DNAME target foo.baddname.example.org denied for foo.baddname.example.net/IN" ns1/named.run >/dev/null || ret=1
 grep "status: SERVFAIL" dig.out.ns1.test${n} > /dev/null || ret=1
 if [ $ret != 0 ]; then echo "I:failed"; fi
 status=`expr $status + $ret`
Index: b/lib/dns/resolver.c
===================================================================
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -6363,13 +6363,14 @@ is_answertarget_allowed(fetchctx_t *fctx
 		dns_name_init(&prefix, NULL);
 		dns_fixedname_init(&fixed);
 		tname = dns_fixedname_name(&fixed);
-		nlabels = dns_name_countlabels(qname) -
-			  dns_name_countlabels(rname);
-		INSIST(nlabels > 0);
+		nlabels = dns_name_countlabels(rname);
 		dns_name_split(qname, nlabels, &prefix, NULL);
 		result = dns_name_concatenate(&prefix, &dname.dname, tname,
 					      NULL);
 		if (result == DNS_R_NAMETOOLONG) {
+			if (chainingp != NULL) {
+				*chainingp = ISC_TRUE;
+			}
 			return (ISC_TRUE);
 		}
 		RUNTIME_CHECK(result == ISC_R_SUCCESS);
