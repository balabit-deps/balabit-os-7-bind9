Description: fix race condition
Origin: backported from patch provided by ISC

Index: bind9-9.11.3+dfsg/lib/dns/dispatch.c
===================================================================
--- bind9-9.11.3+dfsg.orig/lib/dns/dispatch.c	2019-06-18 18:55:03.308360435 -0400
+++ bind9-9.11.3+dfsg/lib/dns/dispatch.c	2019-06-18 18:55:03.308360435 -0400
@@ -3416,13 +3416,14 @@ dns_dispatch_getnext(dns_dispentry_t *re
 	disp = resp->disp;
 	REQUIRE(VALID_DISPATCH(disp));
 
-	REQUIRE(resp->item_out == ISC_TRUE);
-	resp->item_out = ISC_FALSE;
-
 	ev = *sockevent;
 	*sockevent = NULL;
 
 	LOCK(&disp->lock);
+
+	REQUIRE(resp->item_out == ISC_TRUE);
+	resp->item_out = ISC_FALSE;
+
 	if (ev->buffer.base != NULL)
 		free_buffer(disp, ev->buffer.base, ev->buffer.length);
 	free_devent(disp, ev);
@@ -3567,6 +3568,9 @@ dns_dispatch_removeresponse(dns_dispentr
 		isc_task_send(disp->task[0], &disp->ctlevent);
 }
 
+/*
+ * disp must be locked.
+ */
 static void
 do_cancel(dns_dispatch_t *disp) {
 	dns_dispatchevent_t *ev;
